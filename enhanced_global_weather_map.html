import requests
import pandas as pd
import folium
from folium.plugins import HeatMap
import json

API_KEY = "5e75aef282a6008b11cb439c7a5282b3"

city_info = [
    {'City': 'Washington, DC', 'Query': 'Washington,US', 'Lat': 38.9072, 'Lon': -77.0369},
    {'City': 'New York', 'Query': 'New York,US', 'Lat': 40.7128, 'Lon': -74.0060},
    {'City': 'Los Angeles', 'Query': 'Los Angeles,US', 'Lat': 34.0522, 'Lon': -118.2437},
    {'City': 'Toronto', 'Query': 'Toronto,CA', 'Lat': 43.651070, 'Lon': -79.347015},
    {'City': 'London', 'Query': 'London,GB', 'Lat': 51.5074, 'Lon': -0.1278},
    {'City': 'Paris', 'Query': 'Paris,FR', 'Lat': 48.8566, 'Lon': 2.3522},
    {'City': 'Berlin', 'Query': 'Berlin,DE', 'Lat': 52.52, 'Lon': 13.405},
    {'City': 'Tokyo', 'Query': 'Tokyo,JP', 'Lat': 35.6895, 'Lon': 139.6917},
    {'City': 'Seoul', 'Query': 'Seoul,KR', 'Lat': 37.5665, 'Lon': 126.9780},
    {'City': 'Beijing', 'Query': 'Beijing,CN', 'Lat': 39.9042, 'Lon': 116.4074},
    {'City': 'Cairo', 'Query': 'Cairo,EG', 'Lat': 30.0444, 'Lon': 31.2357},
    {'City': 'Riyadh', 'Query': 'Riyadh,SA', 'Lat': 24.7136, 'Lon': 46.6753},
    {'City': 'Jakarta', 'Query': 'Jakarta,ID', 'Lat': -6.2088, 'Lon': 106.8456},
    {'City': 'Buenos Aires', 'Query': 'Buenos Aires,AR', 'Lat': -34.6037, 'Lon': -58.3816},
    {'City': 'Johannesburg', 'Query': 'Johannesburg,ZA', 'Lat': -26.2041, 'Lon': 28.0473},
    {'City': 'Sydney', 'Query': 'Sydney,AU', 'Lat': -33.8688, 'Lon': 151.2093},
    {'City': 'Rabat', 'Query': 'Rabat,MA', 'Lat': 34.0209, 'Lon': -6.8416}
]

weather_data = []
for city in city_info:
    try:
        response = requests.get("https://api.openweathermap.org/data/2.5/weather", params={
            'q': city['Query'], 'appid': API_KEY, 'units': 'metric', 'lang': 'en'
        }, timeout=5)
        if response.status_code == 200:
            data = response.json()
            query_parts = city['Query'].split(',')
            weather_data.append({
                'City': city['City'],
                'Lat': city['Lat'],
                'Lon': city['Lon'],
                'CountryCode': query_parts[1] if len(query_parts) > 1 else 'NA',
                'Temperature (°C)': data['main']['temp'],
                'Humidity (%)': data['main']['humidity'],
                'Wind Speed (m/s)': data['wind']['speed']
            })
    except:
        continue

df = pd.DataFrame(weather_data)

m = folium.Map(location=[20, 0], zoom_start=2, control_scale=True, tiles=None)

# Google Hybrid base
folium.TileLayer(
    tiles="https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",
    name="Google Hybrid",
    attr="Google Hybrid",
    subdomains=['mt0','mt1','mt2','mt3'],
    control=True
).add_to(m)

# Heatmap layer
heat_data = [[row['Lat'], row['Lon'], row['Temperature (°C)']] for _, row in df.iterrows()]
HeatMap(heat_data, radius=20, blur=15, min_opacity=0.4).add_to(m)

# Color logic
def get_marker_color(temp):
    if temp >= 35:
        return 'darkred'
    elif temp >= 30:
        return 'red'
    elif temp >= 25:
        return 'orange'
    elif temp >= 15:
        return 'blue'
    else:
        return 'green'

bounds = []
for _, row in df.iterrows():
    temp_c = row['Temperature (°C)']
    temp_display = (temp_c * 9/5) + 32 if row['CountryCode'] == 'US' else temp_c
    temp_unit = '°F' if row['CountryCode'] == 'US' else '°C'
    folium.Marker(
        location=[row['Lat'], row['Lon']],
        tooltip=f"{row['City']} {temp_display:.1f} {temp_unit}",
        popup=folium.Popup(f"""
        <div style='font-size: 14px;'>
            <b>{row['City']}</b><br>
            🌡️ {temp_c:.1f} °C ({temp_display:.1f} {temp_unit})<br>
            💧 {row['Humidity (%)']}%<br>
            💨 {row['Wind Speed (m/s)']} m/s
        </div>""", max_width=250),
        icon=folium.Icon(color=get_marker_color(temp_c), icon='cloud')
    ).add_to(m)
    bounds.append([row['Lat'], row['Lon']])

m.fit_bounds(bounds)

# Add Layer Control
folium.LayerControl().add_to(m)

# Add attribution box
attribution_html = '''
<div style="
    position: fixed;
    bottom: 10px;
    right: 10px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    padding: 10px;
    font-size: 13px;
    border-radius: 5px;
    z-index: 1000;
    font-family: Arial, sans-serif;">
    Created by <b>Ahmed Mohamed Ibrahim. All rights reserved.</b><br>
    <a href="https://www.linkedin.com/in/ahmedibrahimno1/" target="_blank" style="color: #aad3ff; text-decoration: none;">
        linkedin.com/in/ahmedibrahimno1
    </a>
</div>
'''
m.get_root().html.add_child(folium.Element(attribution_html))

# Save the final output
m.save("enhanced_global_weather_map.html")
print("✅ Map saved as 'enhanced_global_weather_map.html'")
